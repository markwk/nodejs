<?php

/**
 * Implementation of hook_action_info().
 */
function nodejs4d6_actions_action_info() {
  return array(
    'realtime_comment_publish_action' => array(
      'description' => t('Publish realtime notifications Publish comment'),
      'type' => 'comment',
      'configurable' => FALSE,
      'hooks' => array(
        'comment' => array('insert', 'update'),
      ),
    ),
    'realtime_comment_unpublish_action' => array(
      'description' => t('Publish realtime notifications Unpublish comment'),
      'type' => 'comment',
      'configurable' => FALSE,
      'hooks' => array(
        'comment' => array('insert', 'update'),
      )
    ),
    'realtime_comment_unpublish_by_keyword_action' => array(
      'description' => t('Publish realtime notifications Unpublish comment containing keyword(s)'),
      'type' => 'comment',
      'configurable' => TRUE,
      'hooks' => array(
        'comment' => array('insert', 'update'),
      )
    )
  );
}


function realtime_comment_publish_action($comment, $context = array()) {
  if (isset($comment->cid)) {
    $cid = $comment->cid;
    $subject = $comment->subject;
  }
  else {
    $cid = $context['cid'];
    $subject = db_result(db_query("SELECT subject FROM {comments} WHERE cid = %d", $cid));
  }
  db_query('UPDATE {comments} SET status = %d WHERE cid = %d', COMMENT_PUBLISHED, $cid);
  watchdog('action', 'Published comment %subject.', array('%subject' => $subject));
}

/**
 * Implements hook_action_info().
 */
/*function nodejs4d6_actions_action_info() {
  $actions = array();

  //  $triggers = module_invoke_all('trigger_info');
  //$triggers = _nodejs4d6_trigger_info();
  //var_dump($triggers);
  drupal_alter('trigger_info', $triggers);

  foreach (array('comment') as $type) {
    $actions['nodejs4d6_actions_' . $type . '_action'] = array(
      'type' => $type,
      'triggers' => array_keys($triggers[$type]),
      'label' => t('Publish realtime notifications of @type activity.', array('@type' => $type)),
      'configurable' => FALSE,
    );
  }
  return $actions;
}
*/

/**
 * Try to get the action for the given trigger context.
 * 
 * @param mixed $context 
 * @return mixed
 */
function nodejs4d6_actions_get_action($context) {
  $triggers = nodejs4d6_actions_get_triggers();
  if (isset($context['hook'], $triggers[$context['hook']])) {
    return $triggers[$context['hook']];
  }
  return FALSE;
}

/**
 * Returns a list of triggers that we supply an action for.
 * 
 * @return array
 */
function nodejs4d6_actions_get_triggers() {
  return array(
    'comment_insert' => t('inserted'),
    'comment_updated' => t('updated'),
    'node_update' => t('updated'),
    'node_insert' => t('inserted'),
    'user_login' => t('logged in'),
    'user_logout' => t('logged out'),
    'user_insert' => t('was created'),
    'user_updated' => t('was updated'),
  );
}

/**
 * Node object action callback.
 *
 * @param object $node
 * @param array $context
 */
function nodejs4d6_actions_node_action($node, $context = array()) {
  if ($action = nodejs4d6_actions_get_action($context)) {
    $subject = t('Node %action.', array('%action' => $action));
    $link = l($node->title, 'node/' . $node->nid);
    $body = t('The node !link was %action.', array('!link' => $link, '%action' => $action));
    nodejs4d6_actions_enqueue_message($subject, $body);
  }
}

/**
 * Comment object action callback.
 *
 * @param object $node
 * @param array $context
 */
function nodejs4d6_actions_comment_action($comment, $context = array()) {
  if ($action = nodejs4d6_actions_get_action($context)) {
    $subject = t('Comment %action.', array('%action' => $action));
    $link = l($comment->subject, 'node/' . $comment->nid, array('fragment' => 'comment-' . $comment->cid));
    $body = t('The comment !link was %action.', array('!link' => $link, '%action' => $action));
    nodejs4d6_actions_enqueue_message($subject, $body);
  }
}

/**
 * User object action callback.
 *
 * @param object $user
 * @param array $context
 */
function nodejs4d6_actions_user_action($user, $context = array()) {
  if ($action = nodejs4d6_actions_get_action($context)) {
    $subject = t('A user %action.', array('%action' => $action));
    $link = l($user->name, 'user/' . $user->uid);
    $body = t('The user !link %action.', array('!link' => $link, '%action' => $action));
    nodejs4d6_actions_enqueue_message($subject, $body);
  }
}

/**
 * Helper function for enqueueing 'nodejs4d6_notify' channel messages.
 * 
 * @param mixed $subject
 * @param mixed $body
 */
function nodejs4d6_actions_enqueue_message($subject, $body) {
  $message = (object) array(
    'broadcast' => TRUE,
    'data' => (object) array(
      'subject' => $subject,
      'body' => $body,
    ),
    'channel' => 'nodejs4d6_notify',
  );
  nodejs4d6_enqueue_message($message);
}
