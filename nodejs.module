<?php

/**
 * Kick a user off the node.js server.
 *
 * @param mixed $uid 
 */
function nodejs_kick_user($uid) {
  $config = nodejs_get_config();
  $url = 'http://' . $config['host'] . ':' . $config['port'] . "/nodejs/user/kick/$uid";
  $response = drupal_http_request($url);
}

/**
 * Broadcast a message to all clients.
 * 
 * @param string $subject
 * @param string $body
 */
function nodejs_broadcast_message($subject, $body) {
  $message = (object) array(
    'broadcast' => TRUE,
    'data' => (object) array(
      'subject' => $subject,
      'body' => $body,
    ),
    'channel' => 'nodejs_notify',
  );
  nodejs_enqueue_message($message);
}

/**
 * Send a message to given user.
 * 
 * @param int $uid
 * @param string $subject
 * @param string $body
 */
function nodejs_send_user_message($uid, $subject, $body) {
  $message = (object) array(
    'broadcast' => FALSE,
    'data' => (object) array(
      'subject' => $subject,
      'body' => $body,
    ),
    'channel' => 'nodejs_user_' . $uid,
    'callback' => 'nodejsNotify',
  );
  nodejs_enqueue_message($message);
}

/**
 * Implements hook_theme().
 */
function nodejs_theme($existing, $type, $theme, $path) {
  return array(
    'nodejs_stats_page' => array(
      'variables' => array('stats' => new StdClass()),
    ),
  );
}

/**
 * Implements hook_init().
 */
function nodejs_init() {
  $_SESSION['nodejs'] = 'lazy sessions are lazy';
  register_shutdown_function(array('Nodejs', 'sendMessages'));
  $nodejs_config = nodejs_get_config();
  drupal_add_js(drupal_get_path('module', 'nodejs') . '/socket_io/support/socket.io-client/socket.io.js', array('type' => 'file'));
  drupal_add_js(drupal_get_path('module', 'nodejs') . '/nodejs.js', array('type' => 'file'));
  drupal_add_js(array('nodejs' => $nodejs_config), array('type' => 'setting'));
  foreach (nodejs_get_js_handlers() as $handler_file) {
    drupal_add_js($handler_file, array('type' => 'file'));
  }
}

/**
 * Get a list of javascript handler files.
 */
function nodejs_get_js_handlers() {
  $handlers = module_invoke_all('nodejs_handlers_info');
  drupal_alter('nodejs_js_handlers', $handlers);
  return $handlers;
}

/**
 * Implements hook_menu().
 */
function nodejs_menu() {
  return array(
    'nodejs/auth/%' => array(
      'title' => 'Who goes there?',
      'page callback' => 'nodejs_auth_check',
      'page arguments' => array(2),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    ),
    'nodejs/stats' => array(
      'title' => 'Node.js server stats',
      'page callback' => 'nodejs_server_stats_page',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    ),
    'nodejs/user/channel/add' => array(
      'title' => 'Node.js server stats',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('nodejs_add_user_to_channel_form'),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    ),
    'nodejs/stats/users' => array(
      'title' => 'Node.js users stats',
      'page callback' => 'nodejs_users_stats_page',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    ),
    'nodejs/stats/user/%user' => array(
      'title' => 'Node.js user stats',
      'page callback' => 'nodejs_user_stats_page',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    ),
    'nodejs/stats/channel/%channel' => array(
      'title' => 'Node.js channel stats',
      'page callback' => 'nodejs_channel_stats_page',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    ),
  );
}

/**
 * Get a list of active channels from the node.js server.
 * 
 * @access public
 * @return array
 */
function nodejs_get_channels() {
  $config = nodejs_get_config();
  $url = 'http://' . $config['host'] . ':' . $config['port'] . "/nodejs/stats/channels";
  $response = drupal_http_request($url);
  if (isset($response->error)) {
    watchdog('nodejs', t('Error getting channel list from Node.js server: [%code] %error', array('%code' => $response->code, '%error' => $response->error)));
    return array();
  }
  else {
    $channels = drupal_json_decode($response->data);
    return (array) $channels;
  }
}

/**
 * Form callback, add a user to a channel.
 * 
 * @param mixed $form 
 * @param mixed $form_state 
 * @return array
 */
function nodejs_add_user_to_channel_form($form, $form_state) {
  $form = array();
  $form['nodejs_uid'] = array(
    '#type' => 'textfield',
    '#description' => t('The user uid to add to a channel.'),
    '#title' => t('User uid to add'),
  );
  $form['nodejs_channel'] = array(
    '#type' => 'textfield',
    '#description' => t('The name of the channel to give a user access to.'),
    '#title' => t('Channel to add'),
  );
  $form['nodejs_submit'] = array(
    '#type' => 'submit',
    '#value' => t('Add user'),
  );
  return $form;
}

/**
 * Form submit callback - add a user to a channel on the Node.js server.
 * 
 * @param mixed $form
 * @param mixed $form_state
 */
function nodejs_add_user_to_channel_form_submit($form, &$form_state) {
  $values = (object) $form_state['values'];
  if (nodejs_add_user_to_channel($values->nodejs_uid, $values->nodejs_channel)) {
    drupal_set_message(t("Added uid %uid to %channel.", array('%uid' => $values->nodejs_uid, '%channel' => $values->nodejs_channel)));
  }
  else {
    drupal_set_message(t("Failed to add uid %uid to %channel.", array('%uid' => $$values->nodejs_uid, '%channel' => $values->nodejs_channel)), 'error');
  }
}

/**
 * Form validate callback - add a user to a channel on the Node.js server.
 * 
 * @param mixed $form
 * @param mixed $form_state
 * @return void
 */
function nodejs_add_user_to_channel_form_validate($form, &$form_state) {
  $values = (object) $form_state['values'];
  if (!preg_match('/^\d+$/', $values->nodejs_uid)) {
    form_set_error('nodejs_uid', t('Invalid uid - please enter a numeric uid.'));
  }
  if (!preg_match('/^([a-z0-9_]+)$/i', $values->nodejs_channel)) {
    form_set_error('nodejs_channel', t('Invalid channel name - only numbers, letters and underscores are allowed.'));
  }
}

/**
 * Menu callback: renders overall users stats from the Node.js server.
 */
function nodejs_users_stats_page() {
  $page = array(
    '#type' => 'page',
    'content' => array(
      'nodejs' => array(
        '#markup' => __FUNCTION__,
      ),
    ),
  );
  return $page;
}

/**
 * Menu callback: renders stats for the given user from the Node.js server.
 */
function nodejs_user_stats_page($user) {
  $page = array(
    '#type' => 'page',
    'content' => array(
      'nodejs' => array(
        '#markup' => __FUNCTION__,
      ),
    ),
  );
  return $page;
}

/**
 * Menu callback: renders stats for the given channel from the Node.js server.
 */
function nodejs_channel_stats_page($channel) {
  $page = array(
    '#type' => 'page',
    'content' => array(
      'nodejs' => array(
        '#markup' => __FUNCTION__,
      ),
    ),
  );
  return $page;
}

/**
 * Enqueue a message for sending at the end of the request.
 * 
 * @param StdClass $message 
 */
function nodejs_enqueue_message(StdClass $message) {
  drupal_alter('nodejs_message', $message);
  Nodejs::enqueueMessage($message);
}

/**
 * Send a message immediately.
 * 
 * @param StdClass $message 
 */
function nodejs_send_message(StdClass $message) {
  drupal_alter('nodejs_message', $message);
  return Nodejs::sendMessage($message);
}

/**
 * Menu callback: renders overall stats for the Node.js server.
 */
function nodejs_server_stats_page() {
  $page = array(
    '#type' => 'page',
    'content' => array(
      'nodejs' => array(
        '#markup' => theme('nodejs_stats_page', array('stats' => nodejs_get_server_stats())),
      ),
    ),
  );
  return $page;
}

/**
 * Override or insert variables into the page template.
 */
function nodejs_preprocess_page(&$variables) {
  if (variable_get('nodejs_debug', FALSE)) {
    $variables['page']['content']['nodejs_debug'] = array('#markup' => '<div id="nodejs-debug-wrapper"><h3>Node js debug</h3></div>');
  }
}

/**
 * Implements hook_nodejs_user_channels().
 */
function nodejs_nodejs_user_channels($account) {
  if (variable_get('nodejs_enable_userchannel', TRUE) && $account->uid) {
    return array('nodejs_user_' . $account->uid);
  }
}

/**
 * Menu callback: checks the given key to see if it matches a valid session.
 */
function nodejs_auth_check($auth_key) {
  $uid = db_query("SELECT uid FROM {sessions} WHERE MD5(sid) = :auth_key", array(':auth_key' => $auth_key))->fetchField();
  $auth_user = $uid > 0 ? user_load($uid) : drupal_anonymous_user();
  $auth_user->nodejs_valid_auth_key = $uid !== FALSE;
  $auth_user->channels = module_invoke_all('nodejs_user_channels', $auth_user);

  drupal_json_output($auth_user);
  drupal_exit();
}

/**
 * Get nodejs server config.
 */
function nodejs_get_config() {
  global $user;

  static $nodejs_config;

  $channels = module_invoke_all('nodejs_user_channels', $user);
  drupal_alter('nodejs_js_channels', $channels);

  if ($nodejs_config === NULL) {
    $defaults = array(
      'host' => 'localhost',
      'port' => 8080,
      'resource' => '/node.js/realtime',
      'authkey' => md5(session_id()),
      'uid' => $user->uid,
      'channels' => $channels,
    );
    $nodejs_config = variable_get('nodejs_config', array()) + $defaults;
  }
  return $nodejs_config;
}

/**
 * Theme the server stats page
 * 
 * @param StdClass $stats 
 * @return string
 */
function theme_nodejs_stats_page(array $variables) {
  $stats = $variables['stats'];
  if (empty($stats)) {
    return "Error reading Node.js server stats.";
  }
  else {
    $html = '<div class="nodejs-server-stats">';
    $html .= '<h3>Authenticated clients</h3>';
    if (count($stats->authenticatedClients)) {
      $html .= '<ul>';
      foreach ($stats->authenticatedClients as $client) {
        $html .= '<li>' . $client->uid . '</li>';
      }
      $html .= '</ul>';
    }
    else {
      $html .= '<p>There are no authenticated clients</p>';
    }
    $html .= '<h3>Channels</h3>';
    $html .= '</div>';
    return $html;
  }
}

/**
 * Get the stats from the node.js server.
 * 
 * @return StdClass server stats
 */
function nodejs_get_server_stats() {
  $config = nodejs_get_config();
  $url = 'http://' . $config['host'] . ':' . $config['port'] . '/nodejs/stats/server';
  $result = drupal_http_request($url);
  if (isset($result->error)) {
    return (object) array();
  }
  else {
    return (object) json_decode($result->data);
  }
}

/**
 * Add a user to a channel.
 * 
 * @param mixed $uid 
 * @param mixed $channel 
 * @return void
 */
function nodejs_add_user_to_channel($uid, $channel) {
  $config = nodejs_get_config();
  $url = 'http://' . $config['host'] . ':' . $config['port'] . "/nodejs/user/channel/add/$channel/$uid";
  $result = drupal_http_request($url);
  if (isset($result->error)) {
    $params = array(
      '%uid' => $uid,
      '%channel' => $channel,
      '%code' => $result->code,
      '%error' => $result->error,
    );
    watchdog('nodejs', t('Error adding user %uid to channel %channel on Node.js server: [%code] %error', $params));
    return (object) array();
  }
  else {
    return TRUE;
  }
}

class Nodejs {
  public static $messages = array();
  public static function getMessages() {
    return self::$messages;
  }
  public static function enqueueMessage(StdClass $message) {
    self::$messages[] = $message;
  }
  public static function sendMessages() {
    $config = nodejs_get_config();
    foreach (self::$messages as &$message) {
      $message->authkey = session_id();
      drupal_http_request('http://' . $config['host'] . ':' . $config['port'] . '/publish', array('method' => 'POST', 'data' => drupal_json_encode($message)));
    }
  }
  public static function sendMessage(StdClass $message) {
    $config = nodejs_get_config();
    $message->authkey = session_id();
    drupal_http_request('http://' . $config['host'] . ':' . $config['port'] . '/publish', array('method' => 'POST', 'data' => drupal_json_encode($message)));
  }
}

